// Â§öËØ≠Ë®ÄÈÖçÁΩÆ
const i18n = {
    zh: {
        // ÊêúÁ¥¢Áõ∏ÂÖ≥
        searchPlaceholder: 'ÊêúÁ¥¢‰π¶Á≠æ...',
        // ÂàÜÁ±ªÊ†áÁ≠æ
        categoryFolder: 'ÊåâÊñá‰ª∂Â§π',
        categoryDomain: 'ÊåâÁΩëÁ´ô',
        categoryRecent: 'ÊúÄËøëÊ∑ªÂä†',
        categoryAll: 'ÂÖ®ÈÉ®',
        // ËßÜÂõæÂàáÊç¢
        gridView: 'ÁΩëÊ†ºËßÜÂõæ',
        listView: 'ÂàóË°®ËßÜÂõæ',
        // ‰∏ªÈ¢òÂàáÊç¢
        toggleTheme: 'ÂàáÊç¢‰∏ªÈ¢ò',
        followSystemTheme: 'Ë∑üÈöèÁ≥ªÁªü‰∏ªÈ¢ò',
        toggleLanguage: 'ÂàáÊç¢ËØ≠Ë®Ä',
        githubLink: 'Jayson X Github',
        // Á©∫Áä∂ÊÄÅ
        noBookmarks: 'ÊöÇÊó†‰π¶Á≠æ',
        noBookmarksDesc: 'ÂºÄÂßãÊ∑ªÂä†‰∏Ä‰∫õ‰π¶Á≠æÊù•‰∏™ÊÄßÂåñÊÇ®ÁöÑÊñ∞Ê†áÁ≠æÈ°µÂêßÔºÅ',
        noResults: 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑ‰π¶Á≠æ',
        noResultsDesc: 'Â∞ùËØï‰ΩøÁî®‰∏çÂêåÁöÑÂÖ≥ÈîÆËØçÊêúÁ¥¢',
        // Âè≥ÈîÆËèúÂçï
        menuOpen: 'ÊâìÂºÄ',
        menuOpenNewTab: 'Âú®Êñ∞Ê†áÁ≠æÈ°µ‰∏≠ÊâìÂºÄ',
        menuEdit: 'ÁºñËæë',
        menuDelete: 'Âà†Èô§',
        // ÁºñËæëÊ®°ÊÄÅÊ°Ü
        editBookmark: 'ÁºñËæë‰π¶Á≠æ',
        editTitle: 'Ê†áÈ¢ò:',
        editUrl: 'URL:',
        save: '‰øùÂ≠ò',
        cancel: 'ÂèñÊ∂à',
        // Á°ÆËÆ§ÂØπËØùÊ°Ü
        confirmDelete: 'Á°ÆÂÆöË¶ÅÂà†Èô§‰π¶Á≠æ',
        // ÈîôËØØ‰ø°ÊÅØ
        initError: 'ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï',
        loadError: 'Âä†ËΩΩ‰π¶Á≠æÂ§±Ë¥•',
        deleteError: 'Âà†Èô§‰π¶Á≠æÂ§±Ë¥•',
        saveError: '‰øùÂ≠ò‰π¶Á≠æÂ§±Ë¥•',
        errorOccurred: 'Âá∫Áé∞ÈîôËØØ',
        reload: 'ÈáçÊñ∞Âä†ËΩΩ',
        // ÂÖ∂‰ªñ‰π¶Á≠æ
        otherBookmarks: 'ÂÖ∂‰ªñ‰π¶Á≠æ',
        recentAdded: 'ÊúÄËøëÊ∑ªÂä†',
        allBookmarks: 'ÊâÄÊúâ‰π¶Á≠æ',
        urlLabel: 'URL'
    },
    en: {
        // ÊêúÁ¥¢Áõ∏ÂÖ≥
        searchPlaceholder: 'Search bookmarks...',
        // ÂàÜÁ±ªÊ†áÁ≠æ
        categoryFolder: 'Folder',
        categoryDomain: 'Domain',
        categoryRecent: 'Recent',
        categoryAll: 'All',
        // ËßÜÂõæÂàáÊç¢
        gridView: 'Grid View',
        listView: 'List View',
        // ‰∏ªÈ¢òÂàáÊç¢
        toggleTheme: 'Toggle Theme',
        followSystemTheme: 'Follow System Theme',
        toggleLanguage: 'Toggle Language',
        githubLink: 'Jayson X Github',
        // Á©∫Áä∂ÊÄÅ
        noBookmarks: 'No Bookmarks',
        noBookmarksDesc: 'Start adding some bookmarks to personalize your new tab page!',
        noResults: 'No matching bookmarks found',
        noResultsDesc: 'Try searching with different keywords',
        // Âè≥ÈîÆËèúÂçï
        menuOpen: 'Open',
        menuOpenNewTab: 'Open in new tab',
        menuEdit: 'Edit',
        menuDelete: 'Delete',
        // ÁºñËæëÊ®°ÊÄÅÊ°Ü
        editBookmark: 'Edit Bookmark',
        editTitle: 'Title:',
        editUrl: 'URL:',
        save: 'Save',
        cancel: 'Cancel',
        // Á°ÆËÆ§ÂØπËØùÊ°Ü
        confirmDelete: 'Are you sure you want to delete bookmark',
        // ÈîôËØØ‰ø°ÊÅØ
        initError: 'Initialization failed, please refresh the page and try again',
        loadError: 'Failed to load bookmarks',
        deleteError: 'Failed to delete bookmark',
        saveError: 'Failed to save bookmark',
        errorOccurred: 'An error occurred',
        reload: 'Reload',
        // ÂÖ∂‰ªñ‰π¶Á≠æ
        otherBookmarks: 'Other Bookmarks',
        recentAdded: 'Recently Added',
        allBookmarks: 'All Bookmarks',
        urlLabel: 'URL'
    }
};

// Chrome‰π¶Á≠æÈ¶ñÈ°µÂ±ïÁ§∫Êèí‰ª∂ - ‰∏ªË¶ÅÈÄªËæë
class BookmarkManager {
    constructor() {
        this.bookmarks = [];
        this.filteredBookmarks = [];
        this.currentCategory = 'folder';
        this.currentView = 'grid';
        this.searchQuery = '';
        this.theme = 'light';
        this.language = 'zh'; // ÈªòËÆ§‰∏≠Êñá
        this.refreshTimeout = null; // Èò≤ÊäñÂÆöÊó∂Âô®
        
        this.init();
    }

    // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÁöÑÊñáÊú¨
    t(key) {
        return i18n[this.language][key] || key;
    }

    // ÂàùÂßãÂåñ
    async init() {
        try {
            await this.loadSettings();
            await this.loadBookmarks();
            this.setupEventListeners();
            this.applyTheme();
            this.applyLanguage();
            // ËÆæÁΩÆÈªòËÆ§ÂàÜÁ±ªÁä∂ÊÄÅ
            this.switchCategory(this.currentCategory);
        } catch (error) {
            console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            this.showError(this.t('initError'));
        }
    }

    // Âä†ËΩΩËÆæÁΩÆ
    // Ê£ÄÊü•Á≥ªÁªüÊòØÂê¶‰∏∫Ê∑±Ëâ≤Ê®°Âºè
    isSystemDarkMode() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    async loadSettings() {
        try {
            // Ê£ÄÊü•ÊòØÂê¶Âú®ChromeÊâ©Â±ïÁéØÂ¢É‰∏≠
            if (typeof chrome !== 'undefined' && chrome.storage) {
                const result = await chrome.storage.sync.get(['theme', 'viewMode', 'language', 'autoSystemTheme']);
                this.theme = result.theme || 'light';
                this.currentView = result.viewMode || 'grid';
                this.language = result.language || 'zh';
                this.autoSystemTheme = result.autoSystemTheme !== false; // ÈªòËÆ§ÂºÄÂêØË∑üÈöèÁ≥ªÁªü‰∏ªÈ¢ò
            } else {
                // Âú®ÊôÆÈÄöÊµèËßàÂô®ÁéØÂ¢É‰∏≠‰ΩøÁî®localStorage
                this.theme = localStorage.getItem('theme') || 'light';
                this.currentView = localStorage.getItem('viewMode') || 'grid';
                this.language = localStorage.getItem('language') || 'zh';
                this.autoSystemTheme = localStorage.getItem('autoSystemTheme') !== 'false'; // ÈªòËÆ§ÂºÄÂêØË∑üÈöèÁ≥ªÁªü‰∏ªÈ¢ò
            }
            
            // Â¶ÇÊûúÂºÄÂêØ‰∫ÜË∑üÈöèÁ≥ªÁªü‰∏ªÈ¢ò‰∏îÁ≥ªÁªü‰∏∫Ê∑±Ëâ≤Ê®°ÂºèÔºåËá™Âä®ÂàáÊç¢Âà∞Ê∑±Ëâ≤‰∏ªÈ¢ò
            if (this.autoSystemTheme && this.isSystemDarkMode()) {
                this.theme = 'dark';
            }
        } catch (error) {
            console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
        }
    }

    // ‰øùÂ≠òËÆæÁΩÆ
    async saveSettings() {
        try {
            // Ê£ÄÊü•ÊòØÂê¶Âú®ChromeÊâ©Â±ïÁéØÂ¢É‰∏≠
            if (typeof chrome !== 'undefined' && chrome.storage) {
                await chrome.storage.sync.set({
                    theme: this.theme,
                    viewMode: this.currentView,
                    language: this.language,
                    autoSystemTheme: this.autoSystemTheme
                });
            } else {
                // Âú®ÊôÆÈÄöÊµèËßàÂô®ÁéØÂ¢É‰∏≠‰ΩøÁî®localStorage
                localStorage.setItem('theme', this.theme);
                localStorage.setItem('viewMode', this.currentView);
                localStorage.setItem('language', this.language);
                localStorage.setItem('autoSystemTheme', this.autoSystemTheme.toString());
            }
        } catch (error) {
            console.error('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', error);
        }
    }

    // Âä†ËΩΩ‰π¶Á≠æÊï∞ÊçÆ
    async loadBookmarks() {
        const containerEl = document.getElementById('bookmarksContainer');
        
        try {
            // Ê£ÄÊü•ÊòØÂê¶Âú®ChromeÊâ©Â±ïÁéØÂ¢É‰∏≠
            if (typeof chrome !== 'undefined' && chrome.bookmarks) {
                const bookmarkTree = await chrome.bookmarks.getTree();
                this.bookmarks = this.parseBookmarkTree(bookmarkTree);
                // ÁõëÂê¨‰π¶Á≠æÂèòÂåñ
                this.setupBookmarkListeners();
            } else {
                // Âú®ÊôÆÈÄöÊµèËßàÂô®ÁéØÂ¢É‰∏≠‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                this.bookmarks = this.getMockBookmarks();
            }
            
            this.filteredBookmarks = [...this.bookmarks];
            
            containerEl.classList.remove('hidden');
        } catch (error) {
            console.error('Âä†ËΩΩ‰π¶Á≠æÂ§±Ë¥•:', error);
            this.showError('Âä†ËΩΩ‰π¶Á≠æÂ§±Ë¥•');
        }
    }

    // Ëß£Êûê‰π¶Á≠æÊ†ë
    parseBookmarkTree(tree, parentPath = '') {
        const bookmarks = [];
        const folderOrder = new Map(); // ËÆ∞ÂΩïÊñá‰ª∂Â§πÁöÑÂéüÂßãÈ°∫Â∫è
        let folderIndex = 0;
        
        const traverse = (nodes, path, parentIndex = 0) => {
            nodes.forEach((node, index) => {
                if (node.url) {
                    // ËøôÊòØ‰∏Ä‰∏™‰π¶Á≠æ
                    const bookmark = {
                        id: node.id,
                        title: node.title || 'Êú™ÂëΩÂêç‰π¶Á≠æ',
                        url: node.url,
                        dateAdded: node.dateAdded,
                        parentId: node.parentId,
                        folderPath: path,
                        folderOrder: folderOrder.get(path) || 0,
                        bookmarkIndex: index, // ‰π¶Á≠æÂú®Êñá‰ª∂Â§π‰∏≠ÁöÑ‰ΩçÁΩÆ
                        domain: this.extractDomain(node.url),
                        favicon: this.getFaviconUrl(node.url)
                    };
                    bookmarks.push(bookmark);
                } else if (node.children) {
                    // ËøôÊòØ‰∏Ä‰∏™Êñá‰ª∂Â§π
                    const folderPath = path ? `${path} > ${node.title}` : node.title;
                    if (!folderOrder.has(folderPath)) {
                        folderOrder.set(folderPath, folderIndex++);
                    }
                    traverse(node.children, folderPath, index);
                }
            });
        };
        
        traverse(tree, parentPath);
        return bookmarks;
    }

    // ÊèêÂèñÂüüÂêç
    extractDomain(url) {
        try {
            const urlObj = new URL(url);
            return urlObj.hostname.replace('www.', '');
        } catch {
            return 'unknown';
        }
    }

    // Ëé∑ÂèñÁΩëÁ´ôÂõæÊ†áURL
    getFaviconUrl(url) {
        try {
            const urlObj = new URL(url);
            return `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=32`;
        } catch {
            return null;
        }
    }

    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
    setupEventListeners() {
        // ÊêúÁ¥¢ÂäüËÉΩ
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        
        searchInput.addEventListener('input', (e) => {
            this.searchQuery = e.target.value.toLowerCase();
            this.filterAndRenderBookmarks();
        });
        
        searchBtn.addEventListener('click', () => {
            searchInput.focus();
        });

        // ÂàÜÁ±ªÂàáÊç¢
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                this.switchCategory(e.target.dataset.category);
            });
        });

        // ËßÜÂõæÂàáÊç¢
        document.getElementById('gridView').addEventListener('click', () => {
            this.switchView('grid');
        });
        
        document.getElementById('listView').addEventListener('click', () => {
            this.switchView('list');
        });

        // ‰∏ªÈ¢òÂàáÊç¢
        document.getElementById('themeToggle').addEventListener('click', () => {
            this.toggleTheme();
        });

        // ËØ≠Ë®ÄÂàáÊç¢
        document.getElementById('languageToggle').addEventListener('click', () => {
            this.toggleLanguage();
        });

        // GitHubÈìæÊé•
        document.getElementById('githubLink').addEventListener('click', () => {
            window.open('https://github.com/JaysonX-Tech/chrome-bookmark-plugin', '_blank');
        });

        // Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñÁõëÂê¨
        this.setupSystemThemeListener();
        
        // Âè≥ÈîÆËèúÂçï
        this.setupContextMenu();
        
        // ÁºñËæëÊ®°ÊÄÅÊ°Ü
        this.setupEditModal();
    }

    // Ëé∑ÂèñÊ®°Êãü‰π¶Á≠æÊï∞ÊçÆ
    getMockBookmarks() {
        return [
            {
                id: '1',
                title: 'Êú¨Âú∞ÁéØÂ¢É',
                url: 'http://127.0.0.1:8848/nacos',
                dateAdded: Date.now() - 86400000,
                parentId: 'nacos',
                folderPath: 'Nacos',
                domain: '127.0.0.1',
                favicon: 'https://www.google.com/s2/favicons?domain=127.0.0.1&sz=32'
            },
            {
                id: '2',
                title: 'DEV ÁéØÂ¢É',
                url: 'http://10.66.67.2:8083/nacos',
                dateAdded: Date.now() - 172800000,
                parentId: 'nacos',
                folderPath: 'Nacos',
                domain: '10.66.67.2',
                favicon: 'https://www.google.com/s2/favicons?domain=10.66.67.2&sz=32'
            },
            {
                id: '3',
                title: 'SIT ‰ø°ÂàõÁéØÂ¢É',
                url: 'https://sit-xc-nacos.faw.cn/nacos',
                dateAdded: Date.now() - 259200000,
                parentId: 'nacos',
                folderPath: 'Nacos',
                domain: 'sit-xc-nacos.faw.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=sit-xc-nacos.faw.cn&sz=32'
            },
            {
                id: '4',
                title: 'SIT ÁéØÂ¢É',
                url: 'https://sit-iwork.faw.cn/login',
                dateAdded: Date.now() - 345600000,
                parentId: 'iwork',
                folderPath: '‰∏ÄÊ±Ω‰∫ëÂ∑•‰ΩúÂè∞',
                domain: 'sit-iwork.faw.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=sit-iwork.faw.cn&sz=32'
            },
            {
                id: '5',
                title: 'UAT ÁéØÂ¢É',
                url: 'https://uat-iwork.faw.cn/login',
                dateAdded: Date.now() - 432000000,
                parentId: 'iwork',
                folderPath: '‰∏ÄÊ±Ω‰∫ëÂ∑•‰ΩúÂè∞',
                domain: 'uat-iwork.faw.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=uat-iwork.faw.cn&sz=32'
            },
            {
                id: '6',
                title: 'PROD ÁéØÂ¢É',
                url: 'https://iwork.faw.cn/login',
                dateAdded: Date.now() - 518400000,
                parentId: 'iwork',
                folderPath: '‰∏ÄÊ±Ω‰∫ëÂ∑•‰ΩúÂè∞',
                domain: 'iwork.faw.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=iwork.faw.cn&sz=32'
            },
            {
                id: '7',
                title: '032-ÊµÅÊ∞¥Á∫øÂèëÂ∏É',
                url: 'https://iwork.faw.cn/devops/project/overview?appId=5022&businessId=4655969841&content=app&projectId=8333',
                dateAdded: Date.now() - 604800000,
                parentId: 'tools',
                folderPath: 'Âø´Êç∑ÂÖ•Âè£',
                domain: 'iwork.faw.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=iwork.faw.cn&sz=32'
            },
            {
                id: '8',
                title: 'Kimi.ai',
                url: 'https://kimi.moonshot.cn/',
                dateAdded: Date.now() - 691200000,
                parentId: 'websites',
                folderPath: 'Â∏∏Áî®ÁΩëÁ´ô',
                domain: 'kimi.moonshot.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=kimi.moonshot.cn&sz=32'
            },
            {
                id: '9',
                title: 'Á®ÄÂúüÊéòÈáë',
                url: 'https://juejin.cn/recommended',
                dateAdded: Date.now() - 777600000,
                parentId: 'websites',
                folderPath: 'Â∏∏Áî®ÁΩëÁ´ô',
                domain: 'juejin.cn',
                favicon: 'https://www.google.com/s2/favicons?domain=juejin.cn&sz=32'
            },
            {
                id: '10',
                title: 'GitHub',
                url: 'https://github.com',
                dateAdded: Date.now() - 864000000,
                parentId: 'dev',
                folderPath: 'ÂºÄÂèëÂ∑•ÂÖ∑',
                domain: 'github.com',
                favicon: 'https://www.google.com/s2/favicons?domain=github.com&sz=32'
            }
        ];
    }

    // ËÆæÁΩÆ‰π¶Á≠æÂèòÂåñÁõëÂê¨
    setupBookmarkListeners() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            // ÁõëÂê¨Êù•Ëá™background.jsÁöÑÊ∂àÊÅØ
            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                if (message.action && message.action.startsWith('bookmark')) {
                    console.log('Êî∂Âà∞‰π¶Á≠æÂèòÂåñÈÄöÁü•:', message.action, message.data);
                    this.debouncedRefresh();
                }
            });
        }
        
        // Â§áÁî®ÔºöÁõ¥Êé•ÁõëÂê¨‰π¶Á≠æAPIÔºàÂ¶ÇÊûúÊ∂àÊÅØÊú∫Âà∂Â§±ÊïàÔºâ
        if (typeof chrome !== 'undefined' && chrome.bookmarks) {
            chrome.bookmarks.onCreated.addListener(() => {
                this.debouncedRefresh();
            });
            
            chrome.bookmarks.onRemoved.addListener(() => {
                this.debouncedRefresh();
            });
            
            chrome.bookmarks.onChanged.addListener(() => {
                this.debouncedRefresh();
            });
            
            chrome.bookmarks.onMoved.addListener(() => {
                this.debouncedRefresh();
            });
        }
    }

    // Èò≤ÊäñÂà∑Êñ∞‰π¶Á≠æÊï∞ÊçÆ
    debouncedRefresh() {
        // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
        if (this.refreshTimeout) {
            clearTimeout(this.refreshTimeout);
        }
        
        // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®Ôºå300msÂêéÊâßË°åÂà∑Êñ∞
        this.refreshTimeout = setTimeout(() => {
            console.log('ÊâßË°åÈò≤ÊäñÂà∑Êñ∞‰π¶Á≠æÊï∞ÊçÆ');
            this.loadBookmarks().then(() => {
                // Âà∑Êñ∞ÂÆåÊàêÂêéÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçËßÜÂõæ
                this.filterAndRenderBookmarks();
            }).catch(error => {
                console.error('Èò≤ÊäñÂà∑Êñ∞Â§±Ë¥•:', error);
            });
            this.refreshTimeout = null;
        }, 300);
    }

    // ÂàáÊç¢ÂàÜÁ±ª
    switchCategory(category) {
        this.currentCategory = category;
        
        // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-category="${category}"]`).classList.add('active');
        
        this.filterAndRenderBookmarks();
    }

    // ÂàáÊç¢ËßÜÂõæ
    switchView(view) {
        this.currentView = view;
        
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(view + 'View').classList.add('active');
        
        // Êõ¥Êñ∞ÂÆπÂô®Á±ªÂêç
        const container = document.getElementById('bookmarksContainer');
        if (view === 'list') {
            container.classList.add('list-view');
        } else {
            container.classList.remove('list-view');
        }
        
        this.saveSettings();
    }

    // ÂàáÊç¢‰∏ªÈ¢ò
    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        this.applyTheme();
        this.saveSettings();
    }

    // Â∫îÁî®‰∏ªÈ¢ò
    applyTheme() {
        document.documentElement.setAttribute('data-theme', this.theme);
        const themeBtn = document.getElementById('themeToggle');
        themeBtn.textContent = this.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        themeBtn.title = this.t('toggleTheme');
    }

    // ÂàáÊç¢ËØ≠Ë®Ä
    toggleLanguage() {
        this.language = this.language === 'zh' ? 'en' : 'zh';
        this.applyLanguage();
        this.saveSettings();
        // ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢‰ª•Â∫îÁî®Êñ∞ËØ≠Ë®Ä
        this.filterAndRenderBookmarks();
    }

    // Â∫îÁî®ËØ≠Ë®Ä
    applyLanguage() {
        const languageBtn = document.getElementById('languageToggle');
        languageBtn.textContent = this.language === 'zh' ? '‰∏≠' : 'EN';
        languageBtn.title = this.t('toggleLanguage');
        
        // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
        document.title = this.language === 'zh' ? '‰π¶Á≠æÈ¶ñÈ°µ' : 'Bookmark Canvas';
        
        // Êõ¥Êñ∞ÊêúÁ¥¢Ê°ÜÂç†‰ΩçÁ¨¶
        const searchInput = document.getElementById('searchInput');
        searchInput.placeholder = this.t('searchPlaceholder');
        
        // Êõ¥Êñ∞ÂàÜÁ±ªÊ†áÁ≠æ
        const categoryTabs = document.querySelectorAll('.category-tab');
        categoryTabs.forEach(tab => {
            const category = tab.dataset.category;
            switch(category) {
                case 'folder':
                    tab.textContent = this.t('categoryFolder');
                    break;
                case 'domain':
                    tab.textContent = this.t('categoryDomain');
                    break;
                case 'recent':
                    tab.textContent = this.t('categoryRecent');
                    break;
                case 'all':
                    tab.textContent = this.t('categoryAll');
                    break;
            }
        });
        
        // Êõ¥Êñ∞ËßÜÂõæÂàáÊç¢ÊåâÈíÆ
        document.getElementById('gridView').title = this.t('gridView');
        document.getElementById('listView').title = this.t('listView');
        
        // Êõ¥Êñ∞GitHubÊåâÈíÆ
        document.getElementById('githubLink').title = this.t('githubLink');
        
        // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆ
        document.getElementById('themeToggle').title = this.t('toggleTheme');
        
        // Êõ¥Êñ∞Á©∫Áä∂ÊÄÅÊñáÊú¨
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
            const h3 = emptyState.querySelector('h3');
            const p = emptyState.querySelector('p');
            if (h3) h3.textContent = this.t('noBookmarks');
            if (p) p.textContent = this.t('noBookmarksDesc');
        }
        
        // Êõ¥Êñ∞Êó†ÁªìÊûúÁä∂ÊÄÅÊñáÊú¨
        const noResults = document.getElementById('noResults');
        if (noResults) {
            const h3 = noResults.querySelector('h3');
            const p = noResults.querySelector('p');
            if (h3) h3.textContent = this.t('noResults');
            if (p) p.textContent = this.t('noResultsDesc');
        }
        
        // Êõ¥Êñ∞Âè≥ÈîÆËèúÂçï
        this.updateContextMenu();
        
        // Êõ¥Êñ∞ÁºñËæëÊ®°ÊÄÅÊ°Ü
        this.updateEditModal();
    }

    // ËøáÊª§ÂíåÊ∏≤Êüì‰π¶Á≠æ
    filterAndRenderBookmarks() {
        let filtered = [...this.bookmarks];
        
        // ÊêúÁ¥¢ËøáÊª§
        if (this.searchQuery) {
            filtered = filtered.filter(bookmark => 
                bookmark.title.toLowerCase().includes(this.searchQuery) ||
                bookmark.url.toLowerCase().includes(this.searchQuery) ||
                bookmark.domain.toLowerCase().includes(this.searchQuery)
            );
        }
        
        // ÂàÜÁ±ªËøáÊª§
        switch (this.currentCategory) {
            case 'recent':
                filtered = filtered
                    .sort((a, b) => b.dateAdded - a.dateAdded)
                    .slice(0, 50);
                break;
            case 'folder':
            case 'domain':
                // Ëøô‰∫õÂú®Ê∏≤ÊüìÊó∂Â§ÑÁêÜÂàÜÁªÑ
                break;
        }
        
        this.filteredBookmarks = filtered;
        this.renderBookmarks();
    }

    // Ê∏≤Êüì‰π¶Á≠æ
    renderBookmarks() {
        const container = document.getElementById('bookmarksContainer');
        const emptyState = document.getElementById('emptyState');
        const noResults = document.getElementById('noResults');
        
        // ËÆæÁΩÆÂÆπÂô®ÁöÑÂàÜÁ±ªÂ±ûÊÄßÔºåÁî®‰∫éCSSÊ†∑ÂºèÊéßÂà∂
        container.setAttribute('data-category', this.currentCategory);
        
        // Ê∏ÖÁ©∫ÂÆπÂô®
        container.innerHTML = '';
        
        if (this.filteredBookmarks.length === 0) {
            container.classList.add('hidden');
            if (this.searchQuery) {
                noResults.classList.remove('hidden');
                emptyState.classList.add('hidden');
            } else {
                emptyState.classList.remove('hidden');
                noResults.classList.add('hidden');
            }
            return;
        }
        
        container.classList.remove('hidden');
        emptyState.classList.add('hidden');
        noResults.classList.add('hidden');
        
        // Ê†πÊçÆÂàÜÁ±ªÊñπÂºèÂàÜÁªÑ
        const groups = this.groupBookmarks(this.filteredBookmarks);
        
        // Ê∏≤ÊüìÂàÜÁªÑ
        groups.forEach(group => {
            const groupEl = this.createBookmarkGroup(group);
            container.appendChild(groupEl);
        });
    }

    // ÂàÜÁªÑ‰π¶Á≠æ
    groupBookmarks(bookmarks) {
        const groups = new Map();
        
        bookmarks.forEach(bookmark => {
            let groupKey;
            let groupTitle;
            let groupIcon;
            let groupOrder = 0;
            
            switch (this.currentCategory) {
                case 'folder':
                    groupKey = bookmark.folderPath || this.t('otherBookmarks');
                    groupTitle = groupKey;
                    groupIcon = '';
                    groupOrder = bookmark.folderOrder || 0;
                    break;
                case 'domain':
                    groupKey = bookmark.domain;
                    groupTitle = bookmark.domain;
                    groupIcon = '';
                    break;
                case 'recent':
                    groupKey = 'recent';
                    groupTitle = this.t('recentAdded');
                    groupIcon = '';
                    break;
                default:
                    groupKey = 'all';
                    groupTitle = this.t('allBookmarks');
                    groupIcon = '';
            }
            
            if (!groups.has(groupKey)) {
                groups.set(groupKey, {
                    title: groupTitle,
                    icon: groupIcon,
                    order: groupOrder,
                    bookmarks: []
                });
            }
            
            groups.get(groupKey).bookmarks.push(bookmark);
        });
        
        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊåâÂéüÂßãÈ°∫Â∫èÊéíÂ∫è
        const groupsArray = Array.from(groups.values());
        
        // Ê†πÊçÆÂàÜÁ±ªÊñπÂºèÂÜ≥ÂÆöÊéíÂ∫èËßÑÂàô
        if (this.currentCategory === 'folder') {
            // ÊåâÊñá‰ª∂Â§πÁöÑÂéüÂßãÈ°∫Â∫èÊéíÂ∫è
            groupsArray.sort((a, b) => a.order - b.order);
            // ÂêåÊó∂‰øùÊåÅÊØè‰∏™Êñá‰ª∂Â§πÂÜÖ‰π¶Á≠æÁöÑÂéüÂßãÈ°∫Â∫è
            groupsArray.forEach(group => {
                group.bookmarks.sort((a, b) => (a.bookmarkIndex || 0) - (b.bookmarkIndex || 0));
            });
        } else if (this.currentCategory === 'recent') {
            // ÊúÄËøëÊ∑ªÂä†‰øùÊåÅÊó∂Èó¥È°∫Â∫è
            groupsArray.forEach(group => {
                group.bookmarks.sort((a, b) => b.dateAdded - a.dateAdded);
            });
        } else if (this.currentCategory === 'domain') {
            // ÂüüÂêçÂàÜÁªÑÊåâÂ≠óÊØçÈ°∫Â∫è
            groupsArray.sort((a, b) => a.title.localeCompare(b.title));
        }
        
        return groupsArray;
    }

    // ÂàõÂª∫‰π¶Á≠æÂàÜÁªÑÂÖÉÁ¥†
    createBookmarkGroup(group) {
        const groupEl = document.createElement('div');
        groupEl.className = 'bookmark-group';
        
        // ÁßªÈô§ÂÆΩÁâàÈÄªËæëÔºåÊâÄÊúâÂç°ÁâáÈÉΩ‰ΩøÁî®ÂçïÂàóÂÆΩÂ∫¶
        // Áªü‰∏Ä‰∏∫3ÂàóÂ∏ÉÂ±ÄÔºå‰∏çÂÜçÊ†πÊçÆ‰π¶Á≠æÊï∞ÈáèÊ∑ªÂä†wideÁ±ª
        
        // ÂàõÂª∫Ë°®Ê†º
        const tableEl = document.createElement('table');
        tableEl.className = 'bookmark-table';
        
        // ÂàõÂª∫Ë°®Â§¥
        const theadEl = document.createElement('thead');
        const headerRowEl = document.createElement('tr');
        
        const titleHeaderEl = document.createElement('th');
        titleHeaderEl.textContent = group.title;
        titleHeaderEl.style.cursor = 'pointer';
        titleHeaderEl.addEventListener('click', () => {
            this.toggleGroup(groupEl, titleHeaderEl);
        });
        
        const urlHeaderEl = document.createElement('th');
        urlHeaderEl.textContent = this.t('urlLabel');
        
        headerRowEl.appendChild(titleHeaderEl);
        headerRowEl.appendChild(urlHeaderEl);
        theadEl.appendChild(headerRowEl);
        
        // ÂàõÂª∫Ë°®‰Ωì
        const tbodyEl = document.createElement('tbody');
        tbodyEl.className = 'bookmark-list';
        
        group.bookmarks.forEach(bookmark => {
            const rowEl = this.createBookmarkTableRow(bookmark);
            tbodyEl.appendChild(rowEl);
        });
        
        tableEl.appendChild(theadEl);
        tableEl.appendChild(tbodyEl);
        groupEl.appendChild(tableEl);
        
        return groupEl;
    }

    // ÂàõÂª∫‰π¶Á≠æË°®Ê†ºË°åÂÖÉÁ¥†
    createBookmarkTableRow(bookmark) {
        const rowEl = document.createElement('tr');
        rowEl.dataset.bookmarkId = bookmark.id;
        
        // Ê†áÈ¢òÂàó
        const titleCellEl = document.createElement('td');
        const titleLinkEl = document.createElement('a');
        titleLinkEl.href = bookmark.url;
        titleLinkEl.target = '_blank';
        titleLinkEl.textContent = bookmark.title;
        titleLinkEl.title = bookmark.title;
        titleCellEl.appendChild(titleLinkEl);
        
        // URLÂàó
        const urlCellEl = document.createElement('td');
        const urlLinkEl = document.createElement('a');
        urlLinkEl.href = bookmark.url;
        urlLinkEl.target = '_blank';
        urlLinkEl.textContent = bookmark.url;
        urlLinkEl.title = bookmark.url;
        urlCellEl.appendChild(urlLinkEl);
        
        rowEl.appendChild(titleCellEl);
        rowEl.appendChild(urlCellEl);
        
        return rowEl;
    }
    
    // ‰øùÁïôÂéüÊúâÁöÑ‰π¶Á≠æÈ°πÁõÆÂàõÂª∫ÊñπÊ≥ï‰Ωú‰∏∫Â§áÁî®
    createBookmarkItem(bookmark) {
        const itemEl = document.createElement('a');
        itemEl.className = 'bookmark-item';
        itemEl.href = bookmark.url;
        itemEl.target = '_blank';
        itemEl.dataset.bookmarkId = bookmark.id;
        
        const faviconEl = document.createElement('img');
        faviconEl.className = 'bookmark-favicon';
        faviconEl.src = bookmark.favicon;
        faviconEl.onerror = () => {
            faviconEl.style.display = 'none';
            const defaultEl = document.createElement('div');
            defaultEl.className = 'bookmark-favicon default';
            defaultEl.textContent = bookmark.title.charAt(0).toUpperCase();
            itemEl.insertBefore(defaultEl, faviconEl.nextSibling);
        };
        
        const infoEl = document.createElement('div');
        infoEl.className = 'bookmark-info';
        
        const titleEl = document.createElement('div');
        titleEl.className = 'bookmark-title';
        titleEl.textContent = bookmark.title;
        titleEl.title = bookmark.title;
        
        const urlEl = document.createElement('div');
        urlEl.className = 'bookmark-url';
        urlEl.textContent = bookmark.domain;
        urlEl.title = bookmark.url;
        
        infoEl.appendChild(titleEl);
        infoEl.appendChild(urlEl);
        
        itemEl.appendChild(faviconEl);
        itemEl.appendChild(infoEl);
        
        return itemEl;
    }

    // ÂàáÊç¢ÂàÜÁªÑÂ±ïÂºÄ/ÊäòÂè†
    toggleGroup(groupEl, headerEl) {
        const tbodyEl = groupEl.querySelector('.bookmark-list');
        const isCollapsed = tbodyEl.style.display === 'none';
        
        if (isCollapsed) {
            tbodyEl.style.display = '';
            headerEl.style.opacity = '1';
        } else {
            tbodyEl.style.display = 'none';
            headerEl.style.opacity = '0.7';
        }
    }

    // ËÆæÁΩÆÁ≥ªÁªü‰∏ªÈ¢òÂèòÂåñÁõëÂê¨
    setupSystemThemeListener() {
        if (window.matchMedia) {
            const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
            
            // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
            darkModeQuery.addEventListener('change', (e) => {
                if (this.autoSystemTheme) {
                    this.theme = e.matches ? 'dark' : 'light';
                    this.applyTheme();
                    this.saveSettings();
                }
            });
        }
    }

    // ËÆæÁΩÆÂè≥ÈîÆËèúÂçï
    setupContextMenu() {
        const contextMenu = document.getElementById('contextMenu');
        let currentBookmarkId = null;
        
        document.addEventListener('contextmenu', (e) => {
            const bookmarkItem = e.target.closest('.bookmark-item');
            if (bookmarkItem) {
                e.preventDefault();
                currentBookmarkId = bookmarkItem.dataset.bookmarkId;
                
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.classList.remove('hidden');
            }
        });
        
        document.addEventListener('click', () => {
            contextMenu.classList.add('hidden');
        });
        
        // ËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
        contextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (action && currentBookmarkId) {
                this.handleContextMenuAction(action, currentBookmarkId);
            }
            contextMenu.classList.add('hidden');
        });
    }

    // Â§ÑÁêÜÂè≥ÈîÆËèúÂçïÊìç‰Ωú
    async handleContextMenuAction(action, bookmarkId) {
        const bookmark = this.bookmarks.find(b => b.id === bookmarkId);
        if (!bookmark) return;
        
        switch (action) {
            case 'open':
                window.open(bookmark.url, '_self');
                break;
            case 'open-new-tab':
                window.open(bookmark.url, '_blank');
                break;
            case 'edit':
                this.showEditModal(bookmark);
                break;
            case 'delete':
                if (confirm(`${this.t('confirmDelete')} "${bookmark.title}" ÂêóÔºü`)) {
                    try {
                        await chrome.bookmarks.remove(bookmarkId);
                    } catch (error) {
                        console.error('Âà†Èô§‰π¶Á≠æÂ§±Ë¥•:', error);
                        alert(this.t('deleteError'));
                    }
                }
                break;
        }
    }

    // ËÆæÁΩÆÁºñËæëÊ®°ÊÄÅÊ°Ü
    setupEditModal() {
        const modal = document.getElementById('editModal');
        const closeBtn = modal.querySelector('.modal-close');
        const cancelBtn = document.getElementById('cancelEdit');
        const saveBtn = document.getElementById('saveEdit');
        
        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        cancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        saveBtn.addEventListener('click', () => {
            this.saveBookmarkEdit();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    }

    // ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
    showEditModal(bookmark) {
        const modal = document.getElementById('editModal');
        const titleInput = document.getElementById('editTitle');
        const urlInput = document.getElementById('editUrl');
        
        titleInput.value = bookmark.title;
        urlInput.value = bookmark.url;
        modal.dataset.bookmarkId = bookmark.id;
        
        modal.classList.remove('hidden');
        titleInput.focus();
    }

    // ‰øùÂ≠ò‰π¶Á≠æÁºñËæë
    async saveBookmarkEdit() {
        const modal = document.getElementById('editModal');
        const titleInput = document.getElementById('editTitle');
        const urlInput = document.getElementById('editUrl');
        const bookmarkId = modal.dataset.bookmarkId;
        
        if (!bookmarkId) return;
        
        try {
            await chrome.bookmarks.update(bookmarkId, {
                title: titleInput.value.trim(),
                url: urlInput.value.trim()
            });
            modal.classList.add('hidden');
        } catch (error) {
            console.error('‰øùÂ≠ò‰π¶Á≠æÂ§±Ë¥•:', error);
            alert(this.t('saveError'));
        }
    }

    // Êõ¥Êñ∞Âè≥ÈîÆËèúÂçïÊñáÊú¨
    updateContextMenu() {
        const contextMenu = document.getElementById('contextMenu');
        const menuItems = contextMenu.querySelectorAll('.menu-item');
        
        menuItems.forEach(item => {
            const action = item.dataset.action;
            switch(action) {
                case 'open':
                    item.textContent = this.t('menuOpen');
                    break;
                case 'open-new-tab':
                    item.textContent = this.t('menuOpenNewTab');
                    break;
                case 'edit':
                    item.textContent = this.t('menuEdit');
                    break;
                case 'delete':
                    item.textContent = this.t('menuDelete');
                    break;
            }
        });
    }

    // Êõ¥Êñ∞ÁºñËæëÊ®°ÊÄÅÊ°ÜÊñáÊú¨
    updateEditModal() {
        const modal = document.getElementById('editModal');
        const title = modal.querySelector('.modal-header h3');
        const titleLabel = modal.querySelector('label[for="editTitle"]');
        const urlLabel = modal.querySelector('label[for="editUrl"]');
        const saveBtn = document.getElementById('saveEdit');
        const cancelBtn = document.getElementById('cancelEdit');
        
        if (title) title.textContent = this.t('editBookmark');
        if (titleLabel) titleLabel.textContent = this.t('editTitle');
        if (urlLabel) urlLabel.textContent = this.t('editUrl');
        if (saveBtn) saveBtn.textContent = this.t('save');
        if (cancelBtn) cancelBtn.textContent = this.t('cancel');
    }

    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
    showError(message) {
        const container = document.getElementById('bookmarksContainer');
        container.innerHTML = `
            <div class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>${this.t('errorOccurred')}</h3>
                <p>${message}</p>
                <button onclick="location.reload()" class="btn btn-primary">${this.t('reload')}</button>
            </div>
        `;
        container.classList.remove('hidden');
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    new BookmarkManager();
});